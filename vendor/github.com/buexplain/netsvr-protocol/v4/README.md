# netsvr-protocol

这套`proto`是[https://github.com/buexplain/netsvr](https://github.com/buexplain/netsvr)的网关层与业务层的交互协议。

指令有如下三种类别：

1. 网关单向转发给业务进程的指令
2. 业务进程单向请求网关的指令
3. 业务进程请求网关，网关处理完毕再响应给业务进程的指令

### 网关单向转发给业务进程的指令

| 名称                | 编号                                    | proto                                         | 说明                  |
|-------------------|---------------------------------------|-----------------------------------------------|---------------------|
| websocket连接打开     | <a href="cmd.proto#L30">ConnOpen</a>  | <a href="connOpen.proto">connOpen.proto</a>   | 网关转发客户端连接打开的信息到业务进程 |
| websocket连接关闭     | <a href="cmd.proto#L31">ConnClose</a> | <a href="connClose.proto">connClose.proto</a> | 网关转发客户端连接关闭的信息到业务进程 |
| 透传客户端的websocket数据 | <a href="cmd.proto#L32">Transfer</a>  | <a href="transfer.proto">transfer.proto</a>   | 网关转发客户端连接发来的数据到业务进程 |

### 业务进程单向请求网关的指令

| 名称                             | 编号                                                     | proto                                                                           | 说明                                                                                                                          |
|--------------------------------|--------------------------------------------------------|---------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| 更新连接的信息                        | <a href="cmd.proto#L36">ConnInfoUpdate</a>             | <a href="connInfoUpdate.proto">connInfoUpdate.proto</a>                         | 每个客户端连接都可以在网关中存储：业务系统唯一id、订阅的主题标签、session信息，该指令用于设置这些信息                                                                     |
| 删除连接的信息                        | <a href="cmd.proto#L37">ConnInfoDelete</a>             | <a href="connInfoDelete.proto">connInfoDelete.proto</a>                         | 删除客户连接的：业务系统唯一id、订阅的主题标签、session信息                                                                                          |
| 广播                             | <a href="cmd.proto#L38">Broadcast</a>                  | <a href="broadcast.proto">broadcast.proto</a>                                   | 给网关中所有客户端连接都发送一条信息                                                                                                          |
| 根据uniqId组播                     | <a href="cmd.proto#L39">Multicast</a>                  | <a href="multicast.proto">multicast.proto</a>                                   | 给指定的某几个客户端连接发送一条信息                                                                                                          |
| 根据customerId组播                 | <a href="cmd.proto#L40">MulticastByCustomerId</a>      | <a href="multicastByCustomerId.proto">multicastByCustomerId.proto</a>           | 给指定的某几个客户端id发送一条信息                                                                                                          |
| 根据uniqId单播                     | <a href="cmd.proto#L41">SingleCast</a>                 | <a href="singleCast.proto">singleCast.proto</a>                                 | 给指定的某个客户连接发送一条信息                                                                                                            |
| 根据uniqId批量单播                   | <a href="cmd.proto#L42">SingleCastBulk</a>             | <a href="singleCastBulk.proto">singleCastBulk.proto</a>                         | 将多对单播数据打包成一个块，一次性发送给网关                                                                                                      |
| 根据customerId单播                 | <a href="cmd.proto#L43">SingleCastByCustomerId</a>     | <a href="singleCastByCustomerId.proto">singleCastByCustomerId.proto</a>         | 给指定的某个客户端id发送一条信息                                                                                                           |
| 根据customerId批量单播               | <a href="cmd.proto#L44">SingleCastBulkByCustomerId</a> | <a href="singleCastBulkByCustomerId.proto">singleCastBulkByCustomerId.proto</a> | 将多对单播数据打包成一个块，一次性发送给网关                                                                                                      |
| 订阅某几个主题                        | <a href="cmd.proto#L45">TopicSubscribe</a>             | <a href="topicSubscribe.proto">topicSubscribe.proto</a>                         | 客户端连接订阅某几个主题的数据，比如客户端加入的群的id，用于接收该群的消息                                                                                      |
| 取消订阅某几个主题                      | <a href="cmd.proto#L46">TopicUnsubscribe</a>           | <a href="topicUnsubscribe.proto">topicUnsubscribe.proto</a>                     | 客户端连取消订阅某几个主题的数据，比如客户端退群了，可以将之前订阅的群id删除                                                                                     |
| 删除某几个主题                        | <a href="cmd.proto#L47">TopicDelete</a>                | <a href="topicDelete.proto">topicDelete.proto</a>                               | 删除网关中某几个主题，所有订阅了这些被删除主题的客户端连接都会取消订阅它们                                                                                       |
| 给某几个主题发布信息                     | <a href="cmd.proto#L48">TopicPublish</a>               | <a href="topicPublish.proto">topicPublish.proto</a>                             | 一份消息发布到多个主题                                                                                                                 |
| 批量发布到某几个主题                     | <a href="cmd.proto#L49">TopicPublishBulk</a>           | <a href="topicPublishBulk.proto">topicPublishBulk.proto</a>                     | 多份消息发布到多个主题，或者多份消息发布到一个主题                                                                                                   |
| 强制关闭某几个连接                      | <a href="cmd.proto#L50">ForceOffline</a>               | <a href="forceOffline.proto">forceOffline.proto</a>                             | 根据uniqId，强制关闭某几个客户端连接，比如客户在多个设备连接到网关，则可用此指令去强制关闭客户其它设备的连接                                                                   |
| 强制关闭某几个客户的所有连接                 | <a href="cmd.proto#L51">ForceOfflineByCustomerId</a>   | <a href="forceOfflineByCustomerId.proto">forceOfflineByCustomerId.proto</a>     | 根据customerId强制关闭某个客户连接，一般是剔下线用，该客户在所有设备登录到网关的所有连接都会被关闭                                                                      |
| 强制关闭某几个空session、空customerId的连接 | <a href="cmd.proto#L52">ForceOfflineGuest</a>          | <a href="forceOfflineGuest.proto">forceOfflineGuest.proto</a>                   | 强制关闭某个空session值与空customerId的连接，比如客户端连接到网关，但是并没有发起账号密码登录的请求，此时业务侧又不希望此类连接一直逗留在网关中，则可以用该指令去延迟一分钟后强制关闭它，当然如果一分钟后，客户端登录成功，则不会关闭 |

### 业务进程请求网关，网关处理完毕再响应给业务进程的指令

| 名称                                 | 编号                                                       | proto                                                                                                                                                                                 | 说明                                                                  |
|------------------------------------|----------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|
| 注册到网关                              | <a href="cmd.proto#L56">Register</a>                     | <a href="registerReq.proto">registerReq.proto</a>、<a href="registerResp.proto">registerResp.proto</a>                                                                                 | 业务进程向网关的worker服务器发出注册指令，注册成功后，business会收到worker服务器转发的客户端websocket消息 |
| 撤销注册                               | <a href="cmd.proto#L57">Unregister</a>                   | <a href="unRegisterReq.proto">unRegisterReq.proto</a>、<a href="unRegisterResp.proto">unRegisterResp.proto</a>                                                                         | 业务进程向网关的worker服务器发出取消注册指令，取消注册成功后，业务进程不会再收到客户端websocket消息           |
| 检查uniqId是否在线                       | <a href="cmd.proto#L58">CheckOnline</a>                  | <a href="checkOnlineReq.proto">checkOnlineReq.proto</a>、<a href="checkOnlineResp.proto">checkOnlineResp.proto</a>                                                                     | 判断某几个uniqId是否在在线，有则返回uniqId值                                        |
| 获取网关中全部的customerId                 | <a href="cmd.proto#L59">CustomerIdList</a>               | <a href="customerIdListResp.proto">customerIdListResp.proto</a>                                                                                                                       | -                                                                   |
| 统计网关中customerId的数量                 | <a href="cmd.proto#L60">CustomerIdCount</a>              | <a href="customerIdCountResp.proto">customerIdCountResp.proto</a>                                                                                                                     | -                                                                   |
| 获取全部连接的uniqId                      | <a href="cmd.proto#L61">UniqIdList</a>                   | <a href="uniqIdListResp.proto">uniqIdListResp.proto</a>                                                                                                                               | -                                                                   |
| 统计网关的在线连接数                         | <a href="cmd.proto#L62">UniqIdCount</a>                  | <a href="uniqIdCountResp.proto">uniqIdCountResp.proto</a>                                                                                                                             | -                                                                   |
| 获取网关的全部主题                          | <a href="cmd.proto#L63">TopicList</a>                    | <a href="topicListResp.proto">topicListResp.proto</a>                                                                                                                                 | -                                                                   |
| 统计网关的主题数量                          | <a href="cmd.proto#L64">TopicCount</a>                   | <a href="topicCountResp.proto">topicCountResp.proto</a>                                                                                                                               | -                                                                   |
| 获取网关中某几个主题包含的uniqId                | <a href="cmd.proto#L65">TopicUniqIdList</a>              | <a href="topicUniqIdListReq.proto">topicUniqIdListReq.proto</a>、<a href="topicUniqIdListResp.proto">topicUniqIdListResp.proto</a>                                                     | -                                                                   |
| 统计网关中某几个主题包含的uniqId数量              | <a href="cmd.proto#L66">TopicUniqIdCount</a>             | <a href="topicUniqIdCountReq.proto">topicUniqIdCountReq.proto</a>、<a href="topicUniqIdCountResp.proto">topicUniqIdCountResp.proto</a>                                                 | -                                                                   |
| 获取网关中某几个主题的customerId              | <a href="cmd.proto#L67">TopicCustomerIdList</a>          | <a href="topicCustomerIdListReq.proto">topicCustomerIdListReq.proto</a>、<a href="topicCustomerIdListResp.proto">topicCustomerIdListResp.proto</a>                                     | -                                                                   |
| 获取网关中某几个主题的customerId以及对应的uniqId列表 | <a href="cmd.proto#L68">TopicCustomerIdToUniqIdsList</a> | <a href="topicCustomerIdToUniqIdsListReq.proto">topicCustomerIdToUniqIdsListReq.proto</a>、<a href="topicCustomerIdToUniqIdsListResp.proto">topicCustomerIdToUniqIdsListResp.proto</a> | -                                                                   |
| 统计网关某个主题的customerId数量              | <a href="cmd.proto#L69">TopicCustomerIdCount</a>         | <a href="topicCustomerIdCountReq.proto">topicCustomerIdCountReq.proto</a>、<a href="topicCustomerIdCountResp.proto">topicCustomerIdCountResp.proto</a>                                 | -                                                                   |
| 获取uniqId的连接信息                      | <a href="cmd.proto#L70">ConnInfo</a>                     | <a href="connInfoReq.proto">connInfoReq.proto</a>、<a href="connInfoResp.proto">connInfoResp.proto</a>                                                                                 | -                                                                   |
| 获取customerId的连接信息                  | <a href="cmd.proto#L71">ConnInfoByCustomerId</a>         | <a href="connInfoByCustomerIdReq.proto">connInfoByCustomerIdReq.proto</a>、<a href="connInfoByCustomerIdResp.proto">connInfoByCustomerIdResp.proto</a>                                 | -                                                                   |
| 获取网关状态的统计信息                        | <a href="cmd.proto#L72">Metrics</a>                      | <a href="metricsResp.proto">metricsResp.proto</a>                                                                                                                                     | -                                                                   |
| 设置并返回限流配置                          | <a href="cmd.proto#L73">Limit</a>                        | <a href="limitReq.proto">limitReq.proto</a>、<a href="limitResp.proto">limitResp.proto</a>                                                                                             | 先更新限流配置，如果传递的值无效，则会忽略它；再返回网关中的最新的限流配置                               |
