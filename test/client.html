<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>测试网关程序</title>
</head>
<body>
<div style="display:flex">
    <div style="width: 40%">
        <p>
            <button id="open">打开连接</button>
            <button id="close">关闭连接</button>
            <button id="clear">清屏</button>
        </p>

        <p>
            <button id="reqLoginOk">测试登录成功</button>
            <button id="reqLoginFail">测试登录失败</button>
        </p>
    </div>
    <div style="width: 40%;max-height: 70vh;overflow-y: scroll;">
        <div id="sessionId"></div>
        <div id="output"></div>
    </div>
</div>

<script>
    let ws;
    let loginStatus = false;
    let workerId = '001';
    let heartbeat = 0;
    let output = document.getElementById("output");
    let print = function (message) {
        let d = document.createElement("div");
        d.textContent = message;
        output.appendChild(d);
        output.scroll(0, output.scrollHeight);
    };

    /**
     * 发送数据到服务端
     * @param cmd number
     * @param data object|string
     */
    function send(cmd, data) {
        if (!ws) {
            print("请先打开连接");
            return;
        }
        if (cmd !== routerCmd.login && loginStatus === false) {
            print("请先登录");
            return;
        }
        ws.send(workerId + JSON.stringify({
            cmd: cmd,
            data: typeof data == 'object' ? JSON.stringify(data) : data
        }));
    }

    const routerCmd = {
        //连接成功
        connOpen: 1,
        //登录
        login: 2,
    };

    function open() {
        if (ws) {
            return;
        }
        ws = new WebSocket("ws:\/\/127.0.0.1:8080\/gateway");
        ws.onopen = function (evt) {
            console.log(evt);
            heartbeat = setInterval(function () {
                //每隔30秒，发送一次心跳信息
                ws.send('~H27890027B~');
            }, 1000 * 30)
        }
        ws.onclose = function (evt) {
            console.log(evt);
            ws = null;
            clearInterval(heartbeat);
            heartbeat = 0;
            document.getElementById("sessionId").innerText = '断开网关成功，sessionId: 0';
        }
        ws.onmessage = function (evt) {
            //服务端发送心跳检查，则响应一个心跳给服务端
            if (evt.data === '~H27890027B~') {
                ws.send('~H278a0027B~');
                return;
            }
            //服务端响应了客户端的心跳
            if (evt.data === '~H278a0027B~') {
                return;
            }
            try {
                /**
                 * 服务器返回信息
                 * @type {{data: any, cmd: number}}
                 */
                let resp = JSON.parse(evt.data);
                //连接成功，服务端发来了相关信息
                if (resp.cmd === routerCmd.connOpen) {
                    document.getElementById("sessionId").innerText = '连接网关成功，sessionId: ' + resp.data.sessionId;
                    return;
                }
                //服务端响应登录结果
                if (resp.cmd === routerCmd.login) {
                    loginStatus = resp.data.code === 0;
                    print(resp.data.message);
                    return;
                }
                print("Unknown response: " + evt.data);
            } catch (e) {
                console.error(e);
            }
        }
        ws.onerror = function (evt) {
            print("ERROR: " + evt.data);
        }
    }

    function close() {
        ws && ws.close();
    }

    function clear() {
        output.innerHTML = '';
    }

    /**
     * 发送正确的账号密码进行登录
     */
    function reqLoginOk() {
        send(routerCmd.login, {username: '刘备', password: '123456'});
    }

    /**
     * 发送错误的账号密码进行登录
     */
    function reqLoginFail() {
        send(routerCmd.login, {username: '刘备', password: '111111'});
    }

    window.addEventListener("load", function () {
        document.getElementById("open").onclick = open;
        document.getElementById("close").onclick = close;
        document.getElementById("clear").onclick = clear;
        document.getElementById("reqLoginOk").onclick = reqLoginOk;
        document.getElementById("reqLoginFail").onclick = reqLoginFail;
    });
</script>
</body>
</html>