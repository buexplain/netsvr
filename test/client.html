<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>测试网关程序</title>
    <style>
        .case {
            margin-bottom: 15px;
        }

        .case:first-child {
            margin-top: 15px;
        }

        input, select {
            width: 450px;
        }
    </style>
</head>
<body>
<div style="display:flex">
    <div style="width: 65%">
        <div class="case">
            <label for="singleCastMessage">
                <input type="text" id="address" placeholder="请输入连接地址" value="ws://127.0.0.1:6060/netsvr">
            </label>
            <button id="open">打开连接</button>
            <button id="close">关闭连接</button>
            <button id="clear">清屏</button>
        </div>

        <div class="case">
            <label for="username">
                <select id="username">
                    <option>请选择账号</option>
                    <option>玄德</option>
                    <option>云长</option>
                    <option>翼德</option>
                    <option>奉先</option>
                </select>
            </label>
            <button id="login">登录</button>
        </div>

        <div class="case">
            <button id="logout">退出登录</button>
            <button id="updateSessionUserInfo">更新网关中的用户信息</button>
            <button id="netSvrStatus">获取网关状态</button>
            <button id="totalSessionId">获取网关所有在线的session id</button>
            <button id="topicList">获取已订阅的主题列表</button>
        </div>

        <div class="case">
            <label for="singleCastMessage">
                <input type="text" id="singleCastMessage" placeholder="请输入要发送的信息" value="我是一条单播信息">
            </label>
            <label for="singleCastUserId">
                <input type="text" id="singleCastUserId" placeholder="请输入目标用户Id" value="1">
            </label>
            <button id="singleCast">单播</button>
        </div>

        <div class="case">
            <label for="singleCastMessage">
                <input type="text" id="multicastMessage" placeholder="请输入要发送的信息" value="我是一条组播信息">
            </label>
            <label for="singleCastUserId">
                <input type="text" id="multicastUserIds" placeholder="请输入目标用户Id，多个用逗号分割" value="1，2，3">
            </label>
            <button id="multicast">组播</button>
        </div>
        <div class="case">
            <label for="broadcastMessage">
                <input type="text" id="broadcastMessage" placeholder="请输入要发送的信息" value="我是一条广播信息">
            </label>
            <button id="broadcast">广播</button>
        </div>
        <div class="case">
            <label for="subscribe">
                <input type="text" id="subscribeTopics" placeholder="请输入要订阅的主题，多个用逗号分割"
                       value="小品频道，相声频道，戏曲频道，评书频道">
            </label>
            <button id="subscribe">订阅</button>
        </div>
        <div class="case">
            <label for="unsubscribe">
                <input type="text" id="unsubscribeTopics" placeholder="请输入要取消订阅的主题，多个用逗号分割"
                       value="相声频道，小品频道，评书频道">
            </label>
            <button id="unsubscribe">取消订阅</button>
        </div>
        <div class="case">
            <label for="connCountTopics">
                <input type="text" id="connCountTopics"
                       placeholder="请输入主题，多个用逗号分割，没有则表示全部主题" value="戏曲频道">
            </label>
            <button id="topicsConnCount">获取主题连接数</button>
        </div>
        <div class="case">
            <label for="topicsSessionId">
                <input type="text" id="sessionIdTopics"
                       placeholder="请输入主题，多个用逗号分割" value="戏曲频道，评书频道">
            </label>
            <button id="topicsSessionId">获取主题的session id</button>
        </div>
        <div class="case">
            <label for="publishMessage">
                <input type="text" id="publishMessage" placeholder="请输入要发布的信息" value="我是一条发布信息">
            </label>
            <label for="publish">
                <input type="text" id="publishTopic" placeholder="请输入要发布的主题" value="戏曲频道">
            </label>
            <button id="publish">发布</button>
        </div>
    </div>
    <div style="width: 30%;max-height: 70vh;overflow-y: auto;">
        <div id="sessionId"></div>
        <div id="loginInfo"></div>
        <div id="output"></div>
    </div>
</div>

<script>
    let ws;
    let loginStatus = false;
    let workerId = '001';
    let heartbeatInterval = 0;
    let output = document.getElementById("output");
    let print = function (message) {
        let d = document.createElement("div");
        d.textContent = message;
        output.appendChild(d);
        d.scrollIntoView();
    };

    //心跳字符串
    let pingMessage = "~H27890027B~";
    let pongMessage = "~H278a0027B~";

    /**
     * 发送数据到服务端
     * @param cmd number
     * @param data object|string
     */
    function send(cmd, data) {
        if (!ws) {
            print("请先打开连接");
            return;
        }
        if (cmd !== routerCmd.login && loginStatus === false) {
            print("请先登录");
            return;
        }
        ws.send(workerId + JSON.stringify({
            cmd: cmd,
            data: typeof data == 'object' ? JSON.stringify(data) : data
        }));
    }

    /**
     * 发送给business的指令
     */
    const routerCmd = {
        connOpen: 1, //连接成功
        netSvrStatus: 2,//获取网关的信息
        totalSessionId: 3, //获取网关所有在线的session id
        topicList: 4, //获取已订阅的主题列表
        login: 5, //登录
        logout: 6, //退出登录
        updateSessionUserInfo: 7, //更新网关中的用户信息
        singleCast: 8, //单播给某个用户
        multicast: 9, //组播给多个用户
        broadcast: 10, //广播
        subscribe: 11, //订阅
        unsubscribe: 12, //取消订阅
        topicsConnCount: 13, //获取网关中的某几个主题的连接数
        topicsSessionId: 14, //获取网关中的某几个主题的连接session id
        publish: 15, //发布
    };

    function open() {
        if (ws) {
            return;
        }
        ws = new WebSocket(document.getElementById("address").value);
        ws.onopen = function () {
            heartbeatInterval = setInterval(function () {
                //每隔30秒，发送一次心跳信息
                ws.send(pingMessage);
            }, 1000 * 30);
        }
        ws.onclose = function (evt) {
            ws = null;
            clearInterval(heartbeatInterval);
            heartbeatInterval = 0;
            if (evt.code === 1005) {
                //客户端主动断开
                document.getElementById("sessionId").innerText = '断开网关成功，sessionId: 0';
            } else if (evt.code === 1006) {
                //服务端挂了
                document.getElementById("sessionId").innerText = '连接网关失败，网关服务器异常';
            }
            //清空登录成功后的信息
            document.getElementById("loginInfo").innerText = '';
        }
        ws.onmessage = function (evt) {
            //服务端发送心跳检查，则响应一个心跳给服务端
            if (evt.data === pingMessage) {
                ws.send(pongMessage);
                return;
            }
            //服务端响应了客户端的心跳
            if (evt.data === pongMessage) {
                return;
            }
            try {
                /**
                 * 服务器返回信息
                 * @type {{data: any, cmd: number}}
                 */
                let resp = JSON.parse(evt.data);
                //连接成功，服务端发来了相关信息
                if (resp.cmd === routerCmd.connOpen) {
                    clear();
                    document.getElementById("sessionId").innerText = resp.data.message;
                    return;
                }
                //服务端响应网关状态信息
                if (resp.cmd === routerCmd.netSvrStatus) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{customerConnCount: number, topicCount: number, catapultWaitSendCount: number, catapultConsumer: number, catapultChanCap: number}}
                     */
                    let data = resp.data.data;
                    print('网关中的客户连接数 --> ' + data.customerConnCount);
                    print('网关中的主题数量 --> ' + data.topicCount);
                    print('等待转发到客户的数据量 --> ' + data.catapultWaitSendCount);
                    print('等待转发到客户的数据量 --> ' + data.catapultWaitSendCount);
                    print('用户于发送数据给客户的协程数量 --> ' + data.catapultConsumer);
                    print('等待发送给客户数据的缓冲区的大小 --> ' + data.catapultChanCap);
                    return;
                }
                //服务端响应了所有在线的session id
                if (resp.cmd === routerCmd.totalSessionId) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    print(resp.data.message + ' --> ' + resp.data.data.totalSessionId);
                    return;
                }
                if (resp.cmd === routerCmd.topicList) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    if (resp.data.data.topics === null) {
                        print("还未订阅任何主题");
                        return;
                    }
                    print("已经订阅的主题有：" + resp.data.data.topics.join('、'));
                    return;
                }
                //服务端响应了登录结果
                if (resp.cmd === routerCmd.login) {
                    loginStatus = resp.data.code === 0;
                    if (loginStatus) {
                        clear();
                        document.getElementById("loginInfo").innerText = '欢迎”' + resp.data.data.name + '“，您的Id是：' + resp.data.data.id;
                    } else {
                        document.getElementById("loginInfo").innerText = '';
                        print(resp.data.message);
                    }
                    return;
                }
                //服务端响应了退出登录结果
                if (resp.cmd === routerCmd.logout) {
                    loginStatus = !(resp.data.code === 0);
                    if (loginStatus === false) {
                        document.getElementById("loginInfo").innerText = '';
                    }
                    print(resp.data.message);
                    return;
                }
                //服务端响应了更新网关中的用户信息的结果
                if (resp.cmd === routerCmd.updateSessionUserInfo) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{netSvrInfo: object}}
                     */
                    let data = resp.data.data;
                    /**
                     * @type {{LastUpdateTime: string}}
                     */
                    let netSvrInfo = data.netSvrInfo;
                    print('最后更新时间：' + netSvrInfo.LastUpdateTime);
                    return;
                }
                //某某某发来了一条信息
                if (resp.cmd === routerCmd.singleCast || resp.cmd === routerCmd.multicast || resp.cmd === routerCmd.broadcast || resp.cmd === routerCmd.publish) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{fromUser: string, message: string}}
                     */
                    let singleCast = resp.data.data;
                    print(singleCast.fromUser + ": " + singleCast.message);
                    return;
                }
                //服务端响应订阅、取消订阅结果
                if (resp.cmd === routerCmd.subscribe || resp.cmd === routerCmd.unsubscribe) {
                    print(resp.data.message);
                    return;
                }
                //服务端响应了某几个主题的连接数
                if (resp.cmd === routerCmd.topicsConnCount) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    if (resp.data.data === null) {
                        print("未找到任何主题");
                        return;
                    }
                    for (let topic in resp.data.data) {
                        if (!resp.data.data.hasOwnProperty(topic)) {
                            continue;
                        }
                        print('主题：' + topic + ' 有 ' + resp.data.data[topic] + ' 个连接');
                    }
                    return;
                }
                //服务端响应了某几个主题的session id
                if (resp.cmd === routerCmd.topicsSessionId) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    if (resp.data.data === null) {
                        print("未找到任何主题");
                        return;
                    }
                    for (let topic in resp.data.data) {
                        if (!resp.data.data.hasOwnProperty(topic)) {
                            continue;
                        }
                        print('主题：' + topic + ' --> ' + resp.data.data[topic]);
                    }
                    return;
                }
                print("Unknown response: " + evt.data);
            } catch (e) {
                console.error(e);
            }
        }
        ws.onerror = function () {
            document.getElementById("sessionId").innerText = '连接网关失败';
        }
    }

    function close() {
        ws && ws.close();
    }

    function clear() {
        output.innerHTML = '';
    }

    /**
     * 测试获取网关的信息
     */
    function netSvrStatus() {
        send(routerCmd.netSvrStatus, {});
    }

    /**
     * 测试获取网关所有在线的session id
     */
    function totalSessionId() {
        send(routerCmd.totalSessionId, {});
    }

    /**
     * 测试获取已订阅的主题列表
     */
    function topicList() {
        send(routerCmd.topicList, {});
    }

    /**
     * 测试登录
     */
    function login() {
        send(routerCmd.login, {
            username: document.getElementById("username").value,
            password: "123456"
        });
    }

    /**
     * 测试退出登录
     */
    function logout() {
        send(routerCmd.logout, {});
    }

    /**
     * 测试更新网关中的用户信息
     */
    function updateSessionUserInfo() {
        send(routerCmd.updateSessionUserInfo, {});
    }

    /**
     * 测试单播给某个用户
     */
    function singleCast() {
        send(routerCmd.singleCast, {
            message: document.getElementById("singleCastMessage").value,
            userId: parseInt(document.getElementById("singleCastUserId").value)
        });
    }

    /**
     * 测试组播给多个用户
     */
    function multicast() {
        let userIds = [];
        document.getElementById("multicastUserIds").value.replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
            v = v.toString();
            if (v !== '') {
                v = parseInt(v);
                if (typeof v === 'number') {
                    userIds.push(v);
                }
            }
        });
        send(routerCmd.multicast, {
            message: document.getElementById("multicastMessage").value,
            userIds: userIds
        });
    }

    /**
     * 广播
     */
    function broadcast() {
        send(routerCmd.broadcast, {
            message: document.getElementById("broadcastMessage").value,
        });
    }

    /**
     * 订阅
     */
    function subscribe() {
        let topics = [];
        document.getElementById("subscribeTopics").value.replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.subscribe, {
            topics: topics,
        });
    }

    /**
     * 取消订阅
     */
    function unsubscribe() {
        let topics = [];
        document.getElementById("unsubscribeTopics").value.replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.unsubscribe, {
            topics: topics,
        });
    }

    /**
     * 测试获取网关中的某几个主题的连接数
     */
    function topicsConnCount() {
        let topics = [];
        document.getElementById("connCountTopics").value.replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.topicsConnCount, {
            topics: topics,
            getAll: topics.length === 0
        });
    }

    /**
     * 测试获取网关中的某几个主题的连接session id
     */
    function topicsSessionId() {
        let topics = [];
        document.getElementById("sessionIdTopics").value.replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.topicsSessionId, {
            topics: topics,
        });
    }

    /**
     * 测试发布
     */
    function publish() {
        send(routerCmd.publish, {
            message: document.getElementById("publishMessage").value,
            topic: document.getElementById("publishTopic").value
        });
    }

    window.addEventListener("load", function () {
        document.getElementById("open").onclick = open;
        document.getElementById("close").onclick = close;
        document.getElementById("clear").onclick = clear;
        document.getElementById("netSvrStatus").onclick = netSvrStatus;
        document.getElementById("totalSessionId").onclick = totalSessionId;
        document.getElementById("topicList").onclick = topicList;
        document.getElementById("login").onclick = login;
        document.getElementById("logout").onclick = logout;
        document.getElementById("updateSessionUserInfo").onclick = updateSessionUserInfo;
        document.getElementById("singleCast").onclick = singleCast;
        document.getElementById("multicast").onclick = multicast;
        document.getElementById("broadcast").onclick = broadcast;
        document.getElementById("subscribe").onclick = subscribe;
        document.getElementById("unsubscribe").onclick = unsubscribe;
        document.getElementById("topicsConnCount").onclick = topicsConnCount;
        document.getElementById("topicsSessionId").onclick = topicsSessionId;
        document.getElementById("publish").onclick = publish;
    });
</script>
</body>
</html>