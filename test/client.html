<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>测试网关程序</title>
    <style>
        .case {
            margin-bottom: 15px;
        }

        .case:first-child {
            margin-top: 15px;
        }

        input {
            width: 350px;
        }
    </style>
</head>
<body>
<div style="display:flex">
    <div style="width: 50%">
        <div class="case">
            <button id="open">打开连接</button>
            <button id="close">关闭连接</button>
            <button id="netSvrStatus">获取网关状态</button>
            <button id="clear">清屏</button>
        </div>

        <div class="case">
            <label for="username">
                <input type="text" id="username" placeholder="请输入账号" value="刘备">
            </label>
            <label for="password">
                <input type="text" id="password" placeholder="请输入密码" value="123456">
            </label>
            <button id="login">登录</button>
        </div>

        <div class="case">
            <button id="logout">退出登录</button>
            <button id="updateSessionUserInfo">更新网关中的用户信息</button>
        </div>

        <div class="case">
            <label for="singleCastMessage">
                <input type="text" id="singleCastMessage" placeholder="请输入要发送的信息">
            </label>
            <label for="singleCastUserId">
                <input type="text" id="singleCastUserId" placeholder="请输入目标用户Id">
            </label>
            <button id="singleCast">单播</button>
        </div>

        <div class="case">
            <label for="singleCastMessage">
                <input type="text" id="multicastMessage" placeholder="请输入要发送的信息">
            </label>
            <label for="singleCastUserId">
                <input type="text" id="multicastUserIds" placeholder="请输入目标用户Id，多个用逗号分割">
            </label>
            <button id="multicast">组播</button>
        </div>
        <div class="case">
            <label for="broadcastMessage">
                <input type="text" id="broadcastMessage" placeholder="请输入要发送的信息">
            </label>
            <button id="broadcast">广播</button>
        </div>
        <div class="case">
            <label for="subscribe">
                <input type="text" id="subscribeTopics" placeholder="请输入要订阅的主题，多个用逗号分割">
            </label>
            <button id="subscribe">订阅</button>
        </div>
        <div class="case">
            <label for="unsubscribe">
                <input type="text" id="unsubscribeTopics" placeholder="请输入要取消订阅的主题，多个用逗号分割">
            </label>
            <button id="unsubscribe">取消订阅</button>
        </div>
        <div class="case">
            <label for="publishMessage">
                <input type="text" id="publishMessage" placeholder="请输入要发布的信息" value="">
            </label>
            <label for="publish">
                <input type="text" id="publishTopic" placeholder="请输入要发布的主题">
            </label>
            <button id="publish">发布</button>
        </div>
    </div>
    <div style="width: 30%;max-height: 70vh;overflow-y: auto;">
        <div id="sessionId"></div>
        <div id="loginInfo"></div>
        <div id="output"></div>
    </div>
</div>

<script>
    let ws;
    let loginStatus = false;
    let workerId = '001';
    let heartbeatInterval = 0;
    let output = document.getElementById("output");
    let print = function (message) {
        let d = document.createElement("div");
        d.textContent = message;
        output.appendChild(d);
        output.scroll(0, output.scrollHeight);
    };

    //心跳字符串
    let pingMessage = "~H27890027B~";
    let pongMessage = "~H278a0027B~";

    /**
     * 发送数据到服务端
     * @param cmd number
     * @param data object|string
     */
    function send(cmd, data) {
        if (!ws) {
            print("请先打开连接");
            return;
        }
        if (cmd !== routerCmd.login && cmd !== routerCmd.netSvrStatus && loginStatus === false) {
            print("请先登录");
            return;
        }
        ws.send(workerId + JSON.stringify({
            cmd: cmd,
            data: typeof data == 'object' ? JSON.stringify(data) : data
        }));
    }

    /**
     * 发送给工作进程的指令
     */
    const routerCmd = {
        //连接成功
        connOpen: 1,
        //获取网关的信息
        netSvrStatus: 2,
        //登录
        login: 3,
        //退出登录
        logout: 4,
        //更新网关中的用户信息
        updateSessionUserInfo: 5,
        //单播给某个用户
        singleCast: 6,
        //组播给多个用户
        multicast: 7,
        //广播
        broadcast: 8,
        //订阅
        subscribe: 9,
        //取消订阅
        unsubscribe: 10,
        //发布
        publish: 11,
    };

    function open() {
        if (ws) {
            return;
        }
        ws = new WebSocket("ws:\/\/127.0.0.1:8080\/gateway");
        ws.onopen = function () {
            heartbeatInterval = setInterval(function () {
                //每隔30秒，发送一次心跳信息
                ws.send(pingMessage);
            }, 1000 * 30);
        }
        ws.onclose = function (evt) {
            ws = null;
            clearInterval(heartbeatInterval);
            heartbeatInterval = 0;
            if (evt.code === 1005) {
                //客户端主动断开
                document.getElementById("sessionId").innerText = '断开网关成功，sessionId: 0';
            } else if (evt.code === 1006) {
                //服务端挂了
                document.getElementById("sessionId").innerText = '连接网关失败，网关服务器异常';
            }
            //清空登录成功后的信息
            document.getElementById("loginInfo").innerText = '';
        }
        ws.onmessage = function (evt) {
            //服务端发送心跳检查，则响应一个心跳给服务端
            if (evt.data === pingMessage) {
                ws.send(pongMessage);
                return;
            }
            //服务端响应了客户端的心跳
            if (evt.data === pongMessage) {
                return;
            }
            try {
                /**
                 * 服务器返回信息
                 * @type {{data: any, cmd: number}}
                 */
                let resp = JSON.parse(evt.data);
                //连接成功，服务端发来了相关信息
                if (resp.cmd === routerCmd.connOpen) {
                    clear();
                    document.getElementById("sessionId").innerText = resp.data.message;
                    return;
                }
                //服务端响应登录结果
                if (resp.cmd === routerCmd.login) {
                    loginStatus = resp.data.code === 0;
                    if (loginStatus) {
                        clear();
                        document.getElementById("loginInfo").innerText = '欢迎”' + resp.data.data.name + '“，您的Id是：' + resp.data.data.id;
                    } else {
                        document.getElementById("loginInfo").innerText = '';
                        print(resp.data.message);
                    }
                    return;
                }
                //服务端响应退出登录结果
                if (resp.cmd === routerCmd.logout) {
                    loginStatus = !(resp.data.code === 0);
                    if (loginStatus === false) {
                        document.getElementById("loginInfo").innerText = '';
                    }
                    print(resp.data.message);
                    return;
                }
                //服务端响应退出登录结果
                if (resp.cmd === routerCmd.updateSessionUserInfo) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{LastUpdateTime: string}}
                     */
                    let userInfo = resp.data.data.netSvrInfo;
                    print('最后更新时间：' + userInfo.LastUpdateTime);
                    return;
                }
                //某某某发来了一条信息
                if (resp.cmd === routerCmd.singleCast || resp.cmd === routerCmd.multicast || resp.cmd === routerCmd.broadcast || resp.cmd === routerCmd.publish) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{fromUser: string, message: string}}
                     */
                    let singleCast = resp.data.data;
                    print(singleCast.fromUser + ": " + singleCast.message);
                    return;
                }
                //服务端响应订阅结果
                if (resp.cmd === routerCmd.subscribe) {
                    if (resp.data.code === 0) {
                        print(resp.data.message + '，当前在订阅的主题有：' + resp.data.data.topics.toString());
                    } else {
                        print(resp.data.message);
                    }
                    return;
                }
                //服务端响应取消订阅的结果
                if (resp.cmd === routerCmd.unsubscribe) {
                    if (resp.data.code === 0) {
                        if (resp.data.data.topics) {
                            print(resp.data.message + '，当前在订阅的主题有：' + resp.data.data.topics.toString());
                        } else {
                            print(resp.data.message + '，已经没有订阅任何主题了');
                        }
                    } else {
                        print(resp.data.message);
                    }
                    return;
                }
                print("Unknown response: " + evt.data);
            } catch (e) {
                console.error(e);
            }
        }
        ws.onerror = function () {
            document.getElementById("sessionId").innerText = '连接网关失败';
        }
    }

    function close() {
        ws && ws.close();
    }

    function clear() {
        output.innerHTML = '';
    }

    /**
     * 测试获取网关的信息
     */
    function netSvrStatus() {
        send(routerCmd.netSvrStatus, {});
    }

    /**
     * 测试登录
     */
    function login() {
        send(routerCmd.login, {
            username: document.getElementById("username").value,
            password: document.getElementById("password").value
        });
    }

    /**
     * 测试退出登录
     */
    function logout() {
        send(routerCmd.logout, {});
    }

    /**
     * 测试更新网关中的用户信息
     */
    function updateSessionUserInfo() {
        send(routerCmd.updateSessionUserInfo, {});
    }

    /**
     * 测试单播给某个用户
     */
    function singleCast() {
        send(routerCmd.singleCast, {
            message: document.getElementById("singleCastMessage").value,
            userId: parseInt(document.getElementById("singleCastUserId").value)
        });
    }

    /**
     * 测试组播给多个用户
     */
    function multicast() {
        let userIds = [];
        document.getElementById("multicastUserIds").value.split(',').forEach(function (v) {
            v = v.toString();
            if (v !== '') {
                v = parseInt(v);
                if (typeof v === 'number') {
                    userIds.push(v);
                }
            }
        });
        send(routerCmd.multicast, {
            message: document.getElementById("multicastMessage").value,
            userIds: userIds
        });
    }

    /**
     * 广播
     */
    function broadcast() {
        send(routerCmd.broadcast, {
            message: document.getElementById("broadcastMessage").value,
        });
    }

    /**
     * 订阅
     */
    function subscribe() {
        let topics = [];
        document.getElementById("subscribeTopics").value.split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.subscribe, {
            topics: topics,
        });
    }

    /**
     * 取消订阅
     */
    function unsubscribe() {
        let topics = [];
        document.getElementById("unsubscribeTopics").value.split(',').forEach(function (v) {
            v = v.toString().trim();
            if (v !== '') {
                topics.push(v);
            }
        });
        send(routerCmd.unsubscribe, {
            topics: topics,
        });
    }

    /**
     * 测试发布
     */
    function publish() {
        send(routerCmd.publish, {
            message: document.getElementById("publishMessage").value,
            topic: document.getElementById("publishTopic").value
        });
    }

    window.addEventListener("load", function () {
        document.getElementById("open").onclick = open;
        document.getElementById("close").onclick = close;
        document.getElementById("clear").onclick = clear;
        document.getElementById("netSvrStatus").onclick = netSvrStatus;
        document.getElementById("login").onclick = login;
        document.getElementById("logout").onclick = logout;
        document.getElementById("updateSessionUserInfo").onclick = updateSessionUserInfo;
        document.getElementById("singleCast").onclick = singleCast;
        document.getElementById("multicast").onclick = multicast;
        document.getElementById("broadcast").onclick = broadcast;
        document.getElementById("subscribe").onclick = subscribe;
        document.getElementById("unsubscribe").onclick = unsubscribe;
        document.getElementById("publish").onclick = publish;
    });
</script>
</body>
</html>