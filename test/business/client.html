<!doctype html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>测试网关程序</title>
    <style>
        .case {
            margin-bottom: 15px;
        }

        .case:first-child {
            margin-top: 15px;
        }

        input, select {
            width: 420px;
        }
    </style>
    <script>
        /**
         * 转成 int[]
         * @param value
         * @returns {*[]}
         */
        window.processorToIntArr = function (value) {
            let ret = [];
            value.toString().trim().replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
                v = v.toString().trim();
                v = parseInt(v);
                if (typeof v === 'number') {
                    ret.push(v);
                }
            });
            return ret;
        }

        /**
         * 转成 string[]
         * @param value
         * @returns {*[]}
         */
        window.processorToStringArr = function (value) {
            let ret = [];
            value.toString().trim().replaceAll(/[，、]/ig, ',').split(',').forEach(function (v) {
                v = v.toString().trim();
                if (v !== '') {
                    ret.push(v);
                }
            });
            return ret;
        }

        /**
         * 转成string
         * @param value
         * @returns {int}
         */
        window.processorToInt = function (value) {
            value = value.toString().trim();
            return parseInt(value === '' ? '0' : value);
        }

        /**
         * 转成string
         * @param value
         * @returns {string}
         */
        window.processorToString = function (value) {
            return value.toString().trim();
        }
    </script>
</head>
<body>
<div style="display:flex">
    <div style="width: 65%">
        <div class="case">
            <label for="address">
                <input type="text" id="address" placeholder="请输入连接地址" value="{!.conn!}">
            </label>
            <button onclick="openWebsocket()">打开连接</button>
            <button onclick="closeWebsocket()">关闭连接</button>
            <button onclick="clearScreen()">清屏</button>
        </div>

        <div class="case">
            <label>
                <select name="username" data-processor="processorToString">
                    <option>请选择账号</option>
                    <option>玄德</option>
                    <option>云长</option>
                    <option>翼德</option>
                    <option>奉先</option>
                </select>
            </label>
            <input type="hidden" name="password" data-processor="processorToString" value="123456">
            <button onclick="send(this,routerCmd.login)">登录</button>
        </div>

        <div class="case">
            <button onclick="send(null,routerCmd.logout)">退出登录</button>
            <button onclick="send(null,routerCmd.netSvrStatus)">获取网关状态</button>
            <button onclick="send(null,routerCmd.totalUniqIds)">获取网关所有uniqId</button>
            <button onclick="send(null,routerCmd.topicList)">获取已订阅的主题列表</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="userId" data-processor="processorToInt" placeholder="请输入目标用户Id"
                       value="1">
            </label>
            <button onclick="send(this,routerCmd.forceOfflineForUserId)">强制Ta踢下线</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发送的信息"
                       value="我是一条按用户id的单播的信息">
            </label>
            <label>
                <input type="text" name="userId" data-processor="processorToInt" placeholder="请输入目标用户Id"
                       value="1">
            </label>
            <button onclick="send(this,routerCmd.singleCastForUserId)">按用户id单播</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发送的信息"
                       value="我是一条按uniqId单播的信息">
            </label>
            <label>
                <input type="text" name="uniqId" data-processor="processorToString" placeholder="请输入目标uniqId"
                       value="">
            </label>
            <button onclick="send(this,routerCmd.singleCastForUniqId)">按uniqId单播</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发送的信息"
                       value="我是一条按用户id组播的信息">
            </label>
            <label>
                <input type="text" name="userIds" data-processor="processorToIntArr"
                       placeholder="请输入目标用户Id，多个用逗号分割"
                       value="1，2，3">
            </label>
            <button onclick="send(this,routerCmd.multicastForUserId)">按用户id组播</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发送的信息"
                       value="我是一条按uniqId组播的信息">
            </label>
            <label>
                <input type="text" name="uniqIds" data-processor="processorToStringArr"
                       placeholder="请输入目标uniqId，多个用逗号分割"
                       value="">
            </label>
            <button onclick="send(this,routerCmd.multicastForUniqId)">按uniqId组播</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发送的信息"
                       value="我是一条广播信息">
            </label>
            <button onclick="send(this,routerCmd.broadcast)">广播</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="topics" data-processor="processorToStringArr"
                       placeholder="请输入要订阅的主题，多个用逗号分割"
                       value="小品频道，相声频道，戏曲频道，评书频道">
            </label>
            <button onclick="send(this,routerCmd.subscribe)">订阅</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="topics" data-processor="processorToStringArr"
                       placeholder="请输入要取消订阅的主题，多个用逗号分割"
                       value="相声频道，小品频道，评书频道">
            </label>
            <button onclick="send(this,routerCmd.unsubscribe)">取消订阅</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="topics" data-processor="processorToStringArr"
                       placeholder="请输入主题，多个用逗号分割，没有则表示全部主题" value="戏曲频道">
            </label>
            <button onclick="send(this,routerCmd.topicsUniqIdCount)">获取主题连接数</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="topic" data-processor="processorToString"
                       placeholder="请输入主题" value="戏曲频道">
            </label>
            <button onclick="send(this,routerCmd.topicUniqIds)">获取主题的uniqId</button>
        </div>

        <div class="case">
            <label>
                <input type="text" name="message" data-processor="processorToString" placeholder="请输入要发布的信息"
                       value="我是一条发布信息">
            </label>
            <label>
                <input type="text" name="topic" data-processor="processorToString" placeholder="请输入要发布的主题"
                       value="戏曲频道">
            </label>
            <button onclick="send(this,routerCmd.publish)">发布</button>
        </div>
    </div>
    <div style="width: 30%;max-height: 70vh;overflow-y: auto;">
        <div id="topInfo"></div>
        <div id="output"></div>
    </div>
</div>

<script>
    /**
     * 发送给business的指令
     */
    const routerCmd = {
        connOpen: parseInt("{!.RouterRespConnOpen!}"), //连接成功
        netSvrStatus: parseInt("{!.RouterNetSvrStatus!}"),//获取网关的信息
        totalUniqIds: parseInt("{!.RouterTotalUniqIds!}"), //获取网关所有的uniqId
        topicList: parseInt("{!.RouterTopicList!}"), //获取已订阅的主题列表
        login: parseInt("{!.RouterLogin!}"), //登录
        logout: parseInt("{!.RouterLogout!}"), //退出登录
        forceOfflineForUserId: parseInt("{!.RouterForceOfflineForUserId!}"), //强制关闭
        singleCastForUserId: parseInt("{!.RouterSingleCastForUserId!}"), //单播给某个用户
        singleCastForUniqId: parseInt("{!.RouterSingleCastForUniqId!}"), //单播给某个uniqId
        multicastForUserId: parseInt("{!.RouterMulticastForUserId!}"), //组播给多个用户
        multicastForUniqId: parseInt("{!.RouterMulticastForUniqId!}"), //组播给多个uniqId
        broadcast: parseInt("{!.RouterBroadcast!}"), //广播
        subscribe: parseInt("{!.RouterSubscribe!}"), //订阅
        unsubscribe: parseInt("{!.RouterUnsubscribe!}"), //取消订阅
        topicsUniqIdCount: parseInt("{!.RouterTopicsUniqIdCount!}"), //获取网关中的某几个主题的uniqId数
        topicUniqIds: parseInt("{!.RouterTopicUniqIds!}"), //获取网关中的某个主题包含的uniqId
        publish: parseInt("{!.RouterPublish!}"), //发布
    };

    //当前连接
    let ws;

    //是否登录
    let loginStatus = false;

    //business的服务编号
    let workerId = '001';

    //心跳间隔函数的index
    let heartbeatInterval = 0;

    //输入从容器
    let output = document.getElementById("output");

    //输出函数
    let print = function (message) {
        let d = document.createElement("pre");
        d.textContent = message;
        output.appendChild(d);
        d.scrollIntoView();
    };

    //心跳字符串
    let pingMessage = "~H27890027B~";
    let pongMessage = "~H278a0027B~";

    /**
     * 关闭连接
     */
    function closeWebsocket() {
        ws && ws.close();
    }

    /**
     * 清空屏幕
     */
    function clearScreen() {
        output.innerHTML = '';
    }

    /**
     * 发送
     * @param btn
     * @param cmd
     */
    function send(btn, cmd) {
        let param = {};
        if (btn) {
            btn.parentNode.querySelectorAll('input').forEach(function (input) {
                let processor = input.getAttribute('data-processor');
                param[input.name] = processor ? window[processor](input.value) : input.value;
            });
            btn.parentNode.querySelectorAll('select').forEach(function (select) {
                let processor = select.getAttribute('data-processor');
                param[select.name] = processor ? window[processor](select.value) : select.value;
            });
        }
        if (!ws) {
            print("请先打开连接");
            return;
        }
        ws.send(workerId + JSON.stringify({
            cmd: cmd,
            data: JSON.stringify(param)
        }));
    }

    /**
     * 打开连接
     */
    function openWebsocket() {
        if (ws) {
            return;
        }
        ws = new WebSocket(document.getElementById("address").value);
        ws.onopen = function () {
            heartbeatInterval = setInterval(function () {
                //每隔30秒，发送一次心跳信息
                ws.send(pingMessage);
            }, 1000 * 30);
        }
        ws.onclose = function (evt) {
            ws = null;
            clearInterval(heartbeatInterval);
            heartbeatInterval = 0;
            if (evt.code === 1005) {
                //客户端主动断开
                document.getElementById("topInfo").innerText = '断开网关成功';
            } else if (evt.code === 1006) {
                //服务端挂了
                document.getElementById("topInfo").innerText = '连接网关失败，网关服务器异常';
            }
        }
        ws.onmessage = function (evt) {
            //服务端发送心跳检查，则响应一个心跳给服务端
            if (evt.data === pingMessage) {
                ws.send(pongMessage);
                return;
            }
            //服务端响应了客户端的心跳
            if (evt.data === pongMessage) {
                return;
            }
            try {
                /**
                 * 服务器返回信息
                 * @type {{data: any, cmd: number}}
                 */
                let resp = JSON.parse(evt.data);
                //连接成功，服务端发来了相关信息
                if (resp.cmd === routerCmd.connOpen) {
                    clearScreen();
                    document.getElementById("topInfo").innerText = resp.data.message;
                    return;
                }
                //服务端响应了登录结果
                if (resp.cmd === routerCmd.login) {
                    loginStatus = resp.data.code === 0;
                    if (loginStatus) {
                        clearScreen();
                        if (resp.data.data === null) {
                            print(resp.data.message);
                        } else {
                            document.getElementById("topInfo").innerText = '欢迎”' + resp.data.data.name + '“，您的用户Id是：' + resp.data.data.id + '“，您的uniqId是：' + resp.data.data.id;
                        }
                    } else {
                        print(resp.data.message);
                    }
                    return;
                }
                //服务端响应网关状态信息
                if (resp.cmd === routerCmd.netSvrStatus) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    print(JSON.stringify(resp.data.data, null, "  "));
                    return;
                }
                //服务端响应了所有在线的uniqId
                if (resp.cmd === routerCmd.totalUniqIds) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    print(resp.data.message + '：\n' + resp.data.data.totalUniqIds.join('\n'));
                    return;
                }
                //服务端响应了所有的主题列表
                if (resp.cmd === routerCmd.topicList) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    if (resp.data.data.topics === null) {
                        print("还未订阅任何主题");
                        return;
                    }
                    print("已经订阅的主题有：" + resp.data.data.topics.join('、'));
                    return;
                }

                //服务端响应了退出登录结果
                if (resp.cmd === routerCmd.logout) {
                    loginStatus = !(resp.data.code === 0);
                    if (loginStatus === false) {
                        document.getElementById("topInfo").innerText = '';
                    }
                    print(resp.data.message);
                    return;
                }
                //某某某发来了一条信息
                if (
                    resp.cmd === routerCmd.singleCastForUserId
                    || resp.cmd === routerCmd.singleCastForUniqId
                    || resp.cmd === routerCmd.multicastForUniqId
                    || resp.cmd === routerCmd.multicastForUserId
                    || resp.cmd === routerCmd.broadcast
                    || resp.cmd === routerCmd.publish
                ) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    /**
                     * @type {{fromUser: string, message: string}}
                     */
                    let singleCast = resp.data.data;
                    print(singleCast.fromUser + ": " + singleCast.message);
                    return;
                }
                //服务端响应订阅、取消订阅结果
                if (resp.cmd === routerCmd.subscribe || resp.cmd === routerCmd.unsubscribe) {
                    print(resp.data.message);
                    return;
                }
                //服务端响应了某几个主题的uniqId数量
                if (resp.cmd === routerCmd.topicsUniqIdCount) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    if (resp.data.data === null) {
                        print("未找到任何主题");
                        return;
                    }
                    for (let topic in resp.data.data) {
                        if (!resp.data.data.hasOwnProperty(topic)) {
                            continue;
                        }
                        print('主题：' + topic + ' 有 ' + resp.data.data[topic] + ' 个连接');
                    }
                    return;
                }
                //服务端响应了个主题的uniqId
                if (resp.cmd === routerCmd.topicUniqIds) {
                    if (resp.data.code !== 0) {
                        print(resp.data.message);
                        return;
                    }
                    print(resp.data.message);
                    resp.data.data && print(resp.data.data.join('\n'));
                    return;
                }
                print("Unknown response: " + evt.data);
            } catch (e) {
                console.error(e);
            }
        }
        ws.onerror = function () {
            document.getElementById("topInfo").innerText = '连接网关失败';
        }
    }
</script>
</body>
</html>